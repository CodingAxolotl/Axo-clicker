<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Axolotl Clicker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome for the share icon -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script src="https://cloud.umami.is/script.js" data-website-id="d8c86780-e5be-41e5-a6dc-f84ceed23250"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }

    /* CSS for the floating click points animation */
    .click-point {
        position: absolute;
        font-size: 1.5rem;
        font-weight: bold;
        color: #fff;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        opacity: 1;
        animation: floatAndFade 1s forwards;
        pointer-events: none; /* Prevent clicks on the text itself */
        user-select: none; /* Prevent text selection */
    }

    @keyframes floatAndFade {
        0% {
            transform: translateY(0);
            opacity: 1;
        }
        100% {
            transform: translateY(-50px);
            opacity: 0;
        }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-pink-300 via-purple-400 to-indigo-500 min-h-screen flex items-center justify-center p-4 text-gray-800">

  <!-- Custom Modal for Messages -->
  <div id="messageModal" class="fixed inset-0 z-50 hidden bg-gray-900 bg-opacity-75 flex items-center justify-center transition-opacity duration-300">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm m-4 transform transition-transform duration-300 scale-95 hover:scale-100">
      <div class="flex justify-between items-center mb-4">
        <h3 id="messageTitle" class="text-xl font-bold text-pink-600"></h3>
        <button id="modalCloseButton" class="text-gray-400 hover:text-gray-600">×</button>
      </div>
      <p id="messageBody" class="text-gray-700"></p>
    </div>
  </div>

  <!-- Local Storage Permission Modal -->
  <div id="permissionModal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-75 flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm m-4 text-center">
      <h3 class="text-xl font-bold text-purple-600 mb-4">Save Progress?</h3>
      <p class="text-gray-700 mb-6">Do you want to save your game progress in your browser? This will allow you to continue where you left off.</p>
      <div class="flex justify-center gap-4">
        <button id="permissionYes" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-green-600 transition-colors">Yes</button>
        <button id="permissionNo" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-red-600 transition-colors">No</button>
      </div>
    </div>
  </div>

  <!-- Main Game Content -->
  <div id="gameContent" class="hidden flex flex-col lg:flex-row items-center justify-center gap-8 w-full max-w-6xl">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center border-4 border-purple-300">
      <h1 class="text-5xl font-extrabold text-pink-600 mb-4 drop-shadow-md">Axolotl Clicker</h1>

      <!-- Game Status Display -->
      <div id="status" class="space-y-1 mb-6">
        <p class="text-2xl font-semibold">Points: <span id="points" class="font-mono">0</span></p>
        <p class="text-lg">Points per click: <span id="pointsPerClick">1</span></p>
        <p class="text-lg">CPS: <span id="cps">0</span></p>
        <p class="text-lg">Auto Point Giver Level: <span id="autoPointLevel">0</span></p>
        <p class="text-lg">Total Clicks: <span id="clicks">0</span></p>
      </div>

      <!-- Clickable Axolotl Image -->
      <div id="clickButton" class="w-48 h-48 mx-auto mb-6 cursor-pointer relative">
        <img id="axolotlImage" src="Pink.WEBP" alt="A cute axolotl to click" class="w-full h-full object-contain transition-transform duration-200 hover:scale-105">
      </div>

      <!-- Game Buttons -->
      <div class="flex flex-col space-y-4">
        <!-- Save Progress button added and styled green -->
        <button id="saveProgressButton" class="hidden bg-green-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-transform">
          Save Progress
        </button>
        <button id="upgradeButton" class="bg-purple-400 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-transform">
          Upgrade Click to Level 1 — Cost: <span id="upgradeCost">50</span>
        </button>
        <button id="autoUpgradeOneButton" class="bg-cyan-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-transform">
          Buy 1 Auto Point Giver — Cost: 500,000
        </button>
        <button id="autoUpgradeTenButton" class="bg-cyan-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-transform">
          Buy 10 Auto Point Givers — Cost: 4,750,000
        </button>
        <button id="doubleBoostButton" class="bg-yellow-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-transform">
          ⚡ Double Points (15s) — Cost: 20,000
        </button>
        <a href="https://discord.gg/HhSK2VsvP5" target="_blank" class="block">
          <button class="bg-purple-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg w-full transform hover:scale-105 transition-transform">
            Join my discord server!
          </button>
        </a>
      </div>
      <button id="deleteProgressButton" class="mt-6 bg-red-500 text-white font-bold py-2 px-6 rounded-xl shadow-lg w-full transform hover:scale-105 transition-transform">
        Delete All Progress
      </button>
    </div>

    <!-- Skins Panel -->
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center border-4 border-pink-300">
      <h2 class="text-3xl font-bold text-purple-600 mb-4">Axolotl Skins</h2>
      <div id="skinButtons" class="flex flex-wrap justify-center gap-2 mb-4"></div>
      <p class="text-sm text-gray-500">Each skin costs 10,000 points.</p>
    </div>
  </div>

  <!-- ID System Section -->
  <div class="fixed bottom-0 left-0 right-0 bg-white bg-opacity-90 p-4 shadow-lg flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4">
    <div class="flex-grow w-full sm:w-auto">
        <label for="idInput" class="sr-only">Enter Game ID</label>
        <input type="text" id="idInput" placeholder="Enter Game ID to Import" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-purple-400">
    </div>
    <div class="flex space-x-2 w-full sm:w-auto">
        <button id="importIdButton" class="bg-purple-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-purple-600 transition-colors w-full sm:w-auto">Import</button>
        <button id="generateIdButton" class="bg-pink-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-pink-600 transition-colors w-full sm:w-auto">Generate ID</button>
        <!-- New share button -->
        <button id="shareButton" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition-colors w-full sm:w-auto">
            <i class="fas fa-share-alt"></i> Share
        </button>
    </div>
  </div>

  <script>
    // The key for auto-clicker warnings
    const autoClickerWarningsKey = 'axolotlClickerWarnings';
    // Failsafe check to prevent loading a game after auto-clicker punishment.
    const warningsOnLoad = parseInt(localStorage.getItem(autoClickerWarningsKey) || '0', 10);
    if (warningsOnLoad >= 2) {
        localStorage.removeItem('axolotlClickerSave');
        localStorage.removeItem('axolotlClickerPermission');
        localStorage.removeItem(autoClickerWarningsKey);
        window.location.reload();
    }

    // Game state variables
    let points = 0;
    let pointsPerClick = 1;
    let clickUpgradeLevel = 0;
    let clickUpgradeCost = 50;
    let autoPointLevel = 0;
    let bonusMultiplierActive = false;
    let clicks = 0;
    let currentSkin = 0;
    let ownedSkins = [0]; // Start with the first skin owned
    let canUseLocalStorage = false;
    let autoClickerWarnings = parseInt(localStorage.getItem(autoClickerWarningsKey) || '0', 10);

    // CPS related variables
    let clicksThisSecond = 0;
    let cps = 0;
    const cpsThreshold = 20;

    // Encryption-related constants and variables
    const subtle = window.crypto.subtle;
    const encryptionKey = 'axolotlClickerSecretKey'; // A hardcoded key for client-side encryption. Note: not truly secure.
    let cryptoKey;

    // Define skin objects with color and image URL
    const skins = [
      // Updated to use the .WEBP files you provided
      { name: 'Pink', color: '#FF69B4', file: 'Pink.WEBP' },
      { name: 'Light Blue', color: '#87CEFA', file: 'Light.WEBP' },
      { name: 'Blue', color: '#00BFFF', file: 'Blue.WEBP' },
      { name: 'Brown', color: '#8B4513', file: 'Brown.WEBP' },
      { name: 'Yellow', color: '#FFFF00', file: 'Yellow.WEBP' },
      { name: 'Green', color: '#008000', file: 'Green.WEBP' }
    ];

    // UI elements
    const pointsEl = document.getElementById('points');
    const pointsPerClickEl = document.getElementById('pointsPerClick');
    const upgradeCostEl = document.getElementById('upgradeCost');
    const cpsEl = document.getElementById('cps');
    const autoPointLevelEl = document.getElementById('autoPointLevel');
    const clicksEl = document.getElementById('clicks');
    const clickButton = document.getElementById('clickButton');
    const upgradeButton = document.getElementById('upgradeButton');
    const autoUpgradeOneButton = document.getElementById('autoUpgradeOneButton');
    const autoUpgradeTenButton = document.getElementById('autoUpgradeTenButton');
    const doubleBoostButton = document.getElementById('doubleBoostButton');
    const saveProgressButton = document.getElementById('saveProgressButton');
    const skinButtonsContainer = document.getElementById('skinButtons');
    const gameContent = document.getElementById('gameContent');
    const messageModal = document.getElementById('messageModal');
    const messageTitleEl = document.getElementById('messageTitle');
    const messageBodyEl = document.getElementById('messageBody');
    const modalCloseButton = document.getElementById('modalCloseButton');
    const permissionModal = document.getElementById('permissionModal');
    const permissionYesBtn = document.getElementById('permissionYes');
    const permissionNoBtn = document.getElementById('permissionNo');
    const deleteProgressButton = document.getElementById('deleteProgressButton');
    const axolotlImage = document.getElementById('axolotlImage');
    const idInput = document.getElementById('idInput');
    const generateIdButton = document.getElementById('generateIdButton');
    const importIdButton = document.getElementById('importIdButton');
    const shareButton = document.getElementById('shareButton');

    // Function to show the custom modal
    function showModal(title, body) {
        messageTitleEl.textContent = title;
        messageBodyEl.innerHTML = body;
        messageModal.classList.remove('hidden');
    }

    // Function to hide the custom modal
    modalCloseButton.addEventListener('click', () => {
        messageModal.classList.add('hidden');
    });

    // Function to update the UI with current game state
    function updateDisplay() {
      pointsEl.textContent = points.toLocaleString();
      pointsPerClickEl.textContent = pointsPerClick.toLocaleString();
      upgradeCostEl.textContent = clickUpgradeCost.toLocaleString();
      cpsEl.textContent = cps.toLocaleString();
      autoPointLevelEl.textContent = autoPointLevel.toLocaleString();
      clicksEl.textContent = clicks.toLocaleString();
      upgradeButton.innerHTML = `Upgrade Click to Level ${clickUpgradeLevel + 1} — Cost: <span id="upgradeCost">${clickUpgradeCost.toLocaleString()}</span>`;

      // Visual feedback for double boost
      if (bonusMultiplierActive) {
        doubleBoostButton.classList.add('animate-pulse', 'bg-yellow-400');
        doubleBoostButton.classList.remove('bg-yellow-500');
      } else {
        doubleBoostButton.classList.remove('animate-pulse', 'bg-yellow-400');
        doubleBoostButton.classList.add('bg-yellow-500');
      }

      // Update the axolotl image based on the current skin
      axolotlImage.src = skins[currentSkin].file;

      updateSkinButtons();
    }

    // Function to update the skin selection buttons
    function updateSkinButtons() {
      skinButtonsContainer.innerHTML = '';
      skins.forEach((skin, i) => {
        const btn = document.createElement('div');
        btn.classList.add('w-10', 'h-10', 'rounded-lg', 'border-4', 'transition-all', 'duration-200', 'cursor-pointer');
        // Set the background color instead of a background image
        btn.style.backgroundColor = skin.color;
        btn.title = skin.name;

        if (ownedSkins.includes(i)) {
          // If skin is owned, make it selectable
          btn.classList.add('border-gray-400', 'hover:scale-110');
          btn.addEventListener('click', () => {
            currentSkin = i;
            updateDisplay();
          });
        } else {
          // If skin is not owned, make it buyable
          btn.classList.add('border-gray-300');
          btn.title = `Buy ${skin.name} Skin for 10,000 points`;
          btn.addEventListener('click', () => {
            const skinCost = 10000;
            if (points >= skinCost) {
              points -= skinCost;
              ownedSkins.push(i);
              currentSkin = i;
              updateDisplay();
              saveGameState();
              showModal('New Skin Unlocked!', `You bought the ${skin.name} skin!`);
            } else {
              showModal('Not Enough Points!', `You need ${skinCost.toLocaleString()} points to buy the ${skin.name} skin.`);
            }
          });
        }

        if (i === currentSkin) {
          // Highlight the currently selected skin
          btn.classList.remove('border-gray-300', 'border-gray-400');
          btn.classList.add('border-pink-500', 'scale-110');
        }
        skinButtonsContainer.appendChild(btn);
      });
    }

    // Function to save the game state to Local Storage
    function saveGameState() {
        if (!canUseLocalStorage) return;
        const saveData = {
            points, pointsPerClick, clickUpgradeLevel, clickUpgradeCost,
            autoPointLevel, bonusMultiplierActive, clicks, currentSkin, ownedSkins
        };
        try {
            localStorage.setItem('axolotlClickerSave', JSON.stringify(saveData));
            showModal('Game Saved!', 'Your progress has been saved.');
        } catch (e) {
            console.error("Error saving to local storage:", e);
        }
    }

    // Function to load the game state from Local Storage
    function loadGameState() {
        if (!canUseLocalStorage) return;
        try {
            const savedData = JSON.parse(localStorage.getItem('axolotlClickerSave'));
            if (savedData) {
                points = savedData.points || 0;
                pointsPerClick = savedData.pointsPerClick || 1;
                clickUpgradeLevel = savedData.clickUpgradeLevel || 0;
                clickUpgradeCost = savedData.clickUpgradeCost || 50;
                autoPointLevel = savedData.autoPointLevel || 0;
                bonusMultiplierActive = savedData.bonusMultiplierActive || false;
                clicks = savedData.clicks || 0;
                currentSkin = savedData.currentSkin || 0;
                ownedSkins = Array.isArray(savedData.ownedSkins) ? savedData.ownedSkins : [0];
                showModal('Game Loaded!', 'Your game progress has been loaded from your browser.');
            } else {
                showModal('New Game Started', 'Welcome! Your progress can now be saved.');
            }
        } catch (e) {
            console.error("Error loading from local storage:", e);
            showModal('Loading Error', 'Failed to load saved game data. Starting a new game.');
        }
    }

    // Reset game state to defaults
    function resetGameState() {
        points = 0;
        pointsPerClick = 1;
        clickUpgradeLevel = 0;
        clickUpgradeCost = 50;
        autoPointLevel = 0;
        bonusMultiplierActive = false;
        clicks = 0;
        currentSkin = 0;
        ownedSkins = [0];
        autoClickerWarnings = 0;
        updateDisplay();
    }
    
    // Function to create and animate the floating point text
    function createClickPoint(e) {
        const clickPoint = document.createElement('div');
        clickPoint.textContent = `+${pointsPerClick}`;
        clickPoint.classList.add('click-point');

        // Set position relative to the viewport
        clickPoint.style.left = `${e.clientX}px`;
        clickPoint.style.top = `${e.clientY}px`;
        
        document.body.appendChild(clickPoint);

        // Remove the element after the animation is done
        setTimeout(() => {
            clickPoint.remove();
        }, 1000); // Matches the animation duration
    }

    // Event listeners
    axolotlImage.addEventListener('click', (e) => {
      let gain = pointsPerClick;
      if (bonusMultiplierActive) gain *= 2;
      points += gain;
      clicks++;
      clicksThisSecond++; // Increment the clicks for CPS calculation
      updateDisplay();
      createClickPoint(e); // Call the new function to show the floating points
    });
    
    upgradeButton.addEventListener('click', () => {
      if (points >= clickUpgradeCost) {
        points -= clickUpgradeCost;
        clickUpgradeLevel++;
        pointsPerClick++;
        clickUpgradeCost = Math.floor(clickUpgradeCost * 1.2);
        updateDisplay();
      } else {
        showModal('Not enough points!', 'You need more points to upgrade your click.');
      }
    });

    autoUpgradeOneButton.addEventListener('click', () => {
      const cost = 500000;
      if (autoPointLevel >= 500) {
        showModal('Max Level Reached', 'The maximum Auto Point Giver level is 500!');
        return;
      }
      if (points >= cost) {
        points -= cost;
        autoPointLevel++;
        updateDisplay();
      } else {
        showModal('Not enough points!', `You need ${cost.toLocaleString()} points.`);
      }
    });

    autoUpgradeTenButton.addEventListener('click', () => {
      const canBuy = Math.min(10, 500 - autoPointLevel);
      const cost = 4750000;
      if (canBuy > 0 && points >= cost) {
        points -= cost;
        autoPointLevel += canBuy;
        updateDisplay();
      } else if (autoPointLevel >= 500) {
        showModal('Max Level Reached', 'The maximum Auto Point Giver level is 500!');
      } else {
        showModal('Not enough points!', `You need ${cost.toLocaleString()} points.`);
      }
    });

    doubleBoostButton.addEventListener('click', () => {
      const cost = 20000;
      if (points >= cost && !bonusMultiplierActive) {
        points -= cost;
        bonusMultiplierActive = true;
        showModal('Double Points!', 'You are now getting double points for 15 seconds!');
        updateDisplay();
        setTimeout(() => {
          bonusMultiplierActive = false;
          showModal('Boost Expired', 'The double points boost has ended.');
          updateDisplay();
        }, 15000);
      } else if (bonusMultiplierActive) {
        showModal('Boost Active', 'The double points boost is already active.');
      } else {
        showModal('Not enough points!', `You need ${cost.toLocaleString()} points.`);
      }
    });

    saveProgressButton.addEventListener('click', () => {
        saveGameState();
    });
    
    deleteProgressButton.addEventListener('click', () => {
        showModal(
            'Confirm Deletion',
            `<p class="mb-4">Are you sure you want to delete all your game progress? This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="confirmDeleteYes" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition-colors">Yes, Delete</button>
                <button id="confirmDeleteNo" class="bg-gray-400 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-500 transition-colors">No, Cancel</button>
            </div>`
        );
        document.getElementById('confirmDeleteYes').addEventListener('click', () => {
            localStorage.removeItem('axolotlClickerSave');
            messageModal.classList.add('hidden');
            resetGameState();
            showModal('Progress Deleted', 'Your game progress has been deleted. Starting a new game.');
        });
        document.getElementById('confirmDeleteNo').addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });
    });

    // Auto-point generation every second
    setInterval(() => {
        if (autoPointLevel > 500) autoPointLevel = 500;
        points += autoPointLevel;
        updateDisplay();
    }, 1000);

    // CPS calculation and auto-clicker detection every second
    setInterval(() => {
        cps = clicksThisSecond;
        clicksThisSecond = 0; // Reset counter for the next second
        
        // Auto-clicker detection logic based on clicks per second only
        if (cps > cpsThreshold) {
            autoClickerWarnings++;
            localStorage.setItem(autoClickerWarningsKey, autoClickerWarnings);
            
            if (autoClickerWarnings >= 2) {
                // Second offense: delete all progress and reload
                localStorage.removeItem('axolotlClickerSave');
                localStorage.removeItem('axolotlClickerPermission');
                localStorage.removeItem(autoClickerWarningsKey);
                window.location.reload();
            } else {
                // First offense: show warning
                showModal(
                    'Auto Clicker Detected!',
                    "Don't use an auto clicker! (If you use it again your progress will be deleted)"
                );
            }
        }

        updateDisplay();
    }, 1000);

    // Initial game setup and local storage permission
    window.addEventListener('DOMContentLoaded', () => {
        const hasPermission = localStorage.getItem('axolotlClickerPermission');
        if (hasPermission === 'true') {
            canUseLocalStorage = true;
            permissionModal.classList.add('hidden');
            saveProgressButton.classList.remove('hidden'); // Show save button
            const savedData = localStorage.getItem('axolotlClickerSave');
            if (savedData) {
                loadGameState();
            } else {
                showModal('New Game Started', 'Welcome! Your progress can now be saved.');
            }
            gameContent.classList.remove('hidden');
            updateDisplay();
        } else if (hasPermission === 'false') {
            canUseLocalStorage = false;
            permissionModal.classList.add('hidden');
            saveProgressButton.classList.add('hidden'); // Hide save button
            gameContent.classList.remove('hidden');
            updateDisplay();
        } else {
            // Show permission modal for the first time
            permissionModal.classList.remove('hidden');
        }
        
        // Initialize the encryption key
        initCryptoKey();
    });

    permissionYesBtn.addEventListener('click', () => {
        canUseLocalStorage = true;
        localStorage.setItem('axolotlClickerPermission', 'true');
        permissionModal.classList.add('hidden');
        saveProgressButton.classList.remove('hidden'); // Show save button
        const savedData = localStorage.getItem('axolotlClickerSave');
        if (savedData) {
            loadGameState();
        } else {
            showModal('New Game Started', 'Welcome! Your progress can now be saved.');
        }
        gameContent.classList.remove('hidden');
        updateDisplay();
    });

    permissionNoBtn.addEventListener('click', () => {
        canUseLocalStorage = false;
        localStorage.setItem('axolotlClickerPermission', 'false');
        permissionModal.classList.add('hidden');
        saveProgressButton.classList.add('hidden'); // Hide save button
        gameContent.classList.remove('hidden');
        updateDisplay();
        showModal('Progress Not Saved', 'Your progress will not be saved. Please click "Yes" to save data on your next visit.');
    });

    // Helper functions for ArrayBuffer to/from Base64
    function arrayBufferToBase64(buffer) {
      let binary = '';
      const bytes = new Uint8Array(buffer);
      const len = bytes.byteLength;
      for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return window.btoa(binary);
    }

    function base64ToArrayBuffer(base64) {
      const binary_string = window.atob(base64);
      const len = binary_string.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binary_string.charCodeAt(i);
      }
      return bytes.buffer;
    }

    // New ID system functions using Web Crypto API for encryption
    async function initCryptoKey() {
      // Import the hardcoded key. This is not truly secure as it's in the source code,
      // but it provides a significant upgrade from simple encoding.
      const keyBuffer = new TextEncoder().encode(encryptionKey);
      const hashBuffer = await subtle.digest('SHA-256', keyBuffer);

      cryptoKey = await subtle.importKey(
        'raw',
        hashBuffer,
        { name: 'AES-GCM' },
        false,
        ['encrypt', 'decrypt']
      );
    }

    async function generateGameId() {
        if (!cryptoKey) {
            showModal('Error', 'Encryption key not ready. Please try again in a moment.');
            return '';
        }

        const saveData = {
            points, pointsPerClick, clickUpgradeLevel, clickUpgradeCost,
            autoPointLevel, clicks, currentSkin, ownedSkins
        };
        const jsonString = JSON.stringify(saveData);
        const encodedData = new TextEncoder().encode(jsonString);

        const iv = window.crypto.getRandomValues(new Uint8Array(12)); // AES-GCM recommended IV size is 12 bytes

        const encryptedData = await subtle.encrypt(
            { name: 'AES-GCM', iv: iv },
            cryptoKey,
            encodedData
        );

        // Combine IV and encrypted data and encode as Base64 for a single string
        const fullBuffer = new Uint8Array(iv.length + encryptedData.byteLength);
        fullBuffer.set(iv, 0);
        fullBuffer.set(new Uint8Array(encryptedData), iv.length);

        return arrayBufferToBase64(fullBuffer);
    }

    async function importGameId(idString) {
        if (!cryptoKey) {
            showModal('Error', 'Encryption key not ready. Please try again in a moment.');
            return;
        }

        try {
            const fullBuffer = base64ToArrayBuffer(idString);
            const iv = fullBuffer.slice(0, 12);
            const encryptedData = fullBuffer.slice(12);

            const decryptedData = await subtle.decrypt(
                { name: 'AES-GCM', iv: new Uint8Array(iv) },
                cryptoKey,
                encryptedData
            );

            const jsonString = new TextDecoder().decode(decryptedData);
            const loadedData = JSON.parse(jsonString);

            if (loadedData) {
                points = loadedData.points || 0;
                pointsPerClick = loadedData.pointsPerClick || 1;
                clickUpgradeLevel = loadedData.clickUpgradeLevel || 0;
                clickUpgradeCost = loadedData.clickUpgradeCost || 50;
                autoPointLevel = loadedData.autoPointLevel || 0;
                clicks = loadedData.clicks || 0;
                currentSkin = loadedData.currentSkin || 0;
                ownedSkins = Array.isArray(loadedData.ownedSkins) ? loadedData.ownedSkins : [0];
                bonusMultiplierActive = false; // Reset any active boost on import
                showModal('Import Successful!', 'Your game progress has been loaded from the ID.');
                updateDisplay();
            } else {
                showModal('Import Failed', 'The provided ID is invalid or corrupted.');
            }
        } catch (e) {
            console.error("Error importing ID:", e);
            showModal('Import Failed', 'An error occurred while importing the ID. Please check if it is correct.');
        }
    }
    
    // New, more reliable function to copy text to clipboard
    function copyTextToClipboard(text) {
        const tempTextarea = document.createElement('textarea');
        tempTextarea.value = text;
        tempTextarea.style.position = 'fixed';
        tempTextarea.style.left = '-9999px';
        document.body.appendChild(tempTextarea);
        tempTextarea.focus();
        tempTextarea.select();
        try {
            document.execCommand('copy');
            return true;
        } catch (err) {
            console.error('Failed to copy text: ', err);
            return false;
        } finally {
            document.body.removeChild(tempTextarea);
        }
    }


    generateIdButton.addEventListener('click', async () => {
        const id = await generateGameId();
        if (id) {
          idInput.value = id;
          idInput.focus();
          idInput.select();
          showModal('ID Generated', 'Your game ID has been generated. Please copy the text from the box below to share or save it.');
        }
    });

    importIdButton.addEventListener('click', async () => {
        const id = idInput.value;
        if (id) {
            await importGameId(id);
        } else {
            showModal('Import Failed', 'Please enter a valid game ID.');
        }
    });

    shareButton.addEventListener('click', async () => {
        const id = await generateGameId();
        if (!id) {
            return; // Exit silently if no ID can be generated
        }

        const shareData = {
            title: 'My Axolotl Clicker Progress',
            text: `Check out my Axolotl Clicker progress! Here's my game ID: ${id}`,
        };

        if (navigator.share) {
            // Use Web Share API if available
            try {
                await navigator.share(shareData);
            } catch (err) {
                // Do nothing as requested, no "share failed" alert
                console.error('Share failed:', err);
                copyTextToClipboard(shareData.text);
            }
        } else {
            // Fallback for browsers that don't support Web Share API
            copyTextToClipboard(shareData.text);
            showModal('ID Copied!', 'Your game ID and a message have been copied to your clipboard. You can now paste it to share with friends!');
        }
    });
  </script>
</body>
</html>
